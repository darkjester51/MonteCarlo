<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Monte Carlo Cash-Flow Risk Simulator</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
:root{--bg:#0f1318;--fg:#eef3f8;--muted:#a6b2c2;--card:#151c24;--border:#223042;--accent:#6ad1ff;}
*{box-sizing:border-box} html,body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
.container{max-width:1200px;margin:0 auto;padding:18px}
header h1{margin:0 0 6px;font-size:2.1rem;font-weight:800}
header p{margin:0 0 14px;color:var(--muted)}
main{display:grid;grid-template-columns:1fr 1.6fr;gap:14px}
section{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
.inputs h2,.results h2,.notes h2{margin:4px 0 10px}
.inputs h3{margin:12px 0 6px;color:var(--muted);font-weight:700;font-size:.95rem}
.inputs{display:flex;flex-wrap:wrap;align-items:flex-start}
.inputs label{display:flex;flex-direction:column;gap:6px;margin:6px 10px 8px 0;min-width:220px;flex:1}
.inputs input,.inputs select{background:#0e141b;color:var(--fg);border:1px solid var(--border);border-radius:10px;padding:8px 10px}
.inputs input:focus,.inputs select:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(106,209,255,.15);outline:none}
#runBtn{margin-top:6px;background:var(--accent);color:#00131b;border:none;border-radius:10px;padding:10px 14px;font-weight:800;cursor:pointer}
#runBtn:disabled{opacity:.6;cursor:not-allowed}
#status{margin:8px 0 2px;color:var(--muted)}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:6px 0 8px}
.kpis>div{background:#0e141b;border:1px solid var(--border);border-radius:12px;padding:10px 12px;min-height:64px;display:flex;flex-direction:column;justify-content:center}
.kpis .label{color:var(--muted);font-size:.85rem}
.kpis .val{font-weight:800;font-size:1.25rem;margin-top:6px}
.chart{height:360px;border:1px solid var(--border);border-radius:12px;margin:10px 0}
#tornadoChart{height:320px}
.notes pre{margin:0;padding:12px;background:#0e141b;border:1px solid var(--border);border-radius:12px;color:var(--fg);overflow:auto;font-size:.92rem;line-height:1.35}
footer{margin-top:12px;color:var(--muted);font-size:.9rem}
@media (max-width:980px){main{grid-template-columns:1fr}.kpis{grid-template-columns:repeat(2,1fr)}.chart{height:300px}}
@media (max-width:560px){.kpis{grid-template-columns:1fr}header h1{font-size:1.6rem}}
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>Monte Carlo Cash-Flow Risk Simulator</h1>
    <p>Fast, client-side simulator with uncertainty bands, shortfall probability, VaR, and sensitivity.</p>
  </header>

  <main>
    <section class="inputs">
      <h2>Inputs</h2>
      <label>Months <input id="periods" type="number" min="3" max="60" value="12"></label>
      <label>Simulations <input id="sims" type="number" min="1000" max="100000" step="1000" value="10000"></label>
      <label>Seed (optional) <input id="seed" type="number" placeholder="e.g., 42"></label>

      <h3>Demand & Revenue</h3>
      <label>Demand distribution
        <select id="demandDist"><option value="normal" selected>Normal</option><option value="lognormal">Lognormal</option><option value="poisson">Poisson</option></select>
      </label>
      <label>Demand mean / λ <input id="demandMu" type="number" step="1" value="500"></label>
      <label>Demand std (ignored for Poisson) <input id="demandSigma" type="number" step="1" value="120"></label>
      <label>Average order value ($) <input id="aov" type="number" step="1" value="40"></label>

      <h3>COGS & Costs</h3>
      <label>COGS (% of revenue) <input id="cogsPct" type="number" min="0" max="100" step="1" value="45"></label>
      <label>Variable Opex (% of revenue) <input id="varCostPct" type="number" min="0" max="100" step="1" value="8"></label>
      <label>Fixed monthly cost ($) <input id="fixedCost" type="number" step="100" value="18000"></label>
      <label>Starting cash ($) <input id="startingCash" type="number" step="100" value="50000"></label>

      <h3>Cash Timing & Taxes</h3>
      <label>DSO (days sales outstanding) <input id="dsoDays" type="number" min="0" max="120" value="30"></label>
      <label>Late pay share (% shifted +1 mo) <input id="latePayPct" type="number" min="0" max="100" value="10"></label>
      <label>Tax rate (% on positive PBT) <input id="taxRate" type="number" min="0" max="60" value="0"></label>
      <label>Shortfall threshold ($) <input id="shortfallThresh" type="number" step="100" value="0"></label>

      <button id="runBtn">Run Simulation</button>
      <div id="status">Idle.</div>
    </section>

    <section class="results">
      <h2>Results</h2>
      <div class="kpis">
        <div><div class="label">Any shortfall</div><div class="val" id="kpiShortfall">–</div></div>
        <div><div class="label">End cash &lt; 0</div><div class="val" id="kpiEndNeg">–</div></div>
        <div><div class="label">VaR₅% (End Cash)</div><div class="val" id="kpiVaR">–</div></div>
        <div><div class="label">Median End Cash</div><div class="val" id="kpiMedian">–</div></div>
      </div>

      <div id="fanChart" class="chart"></div>
      <div id="histChart" class="chart"></div>
      <h3>Sensitivity — Tornado (ΔP(Shortfall))</h3>
      <div id="tornadoChart" class="chart"></div>
    </section>
  </main>

  <section class="notes">
    <h2>Model Notes (transparent by design)</h2>
<pre>
Revenue_t = Demand_t × AOV
COGS_t = COGS% × Revenue_t
VarOpex_t = VarCost% × Revenue_t
Fixed_t = Fixed monthly cost
PBT_t = Revenue_t − (COGS_t + VarOpex_t + Fixed_t)
Tax_t = Tax% × max(PBT_t, 0)

Cash in: Revenue collected after DSO months; LatePay% is delayed by +1 month.
Cash_t = Cash_{t−1} + CashIn_t − (COGS_t + VarOpex_t + Fixed_t − Tax_t)
</pre>
  </section>

  <footer><p>© <span id="year"></span> Monte Carlo Cash-Flow Risk — static & auditable</p></footer>
</div>

<script>
/* ===== UI wiring ===== */
const el = {};
window.addEventListener('load', () => {
  ["periods","sims","seed","demandDist","demandMu","demandSigma","aov",
   "cogsPct","varCostPct","startingCash","fixedCost","dsoDays","latePayPct",
   "taxRate","shortfallThresh","runBtn","status",
   "kpiShortfall","kpiEndNeg","kpiVaR","kpiMedian",
   "fanChart","histChart","tornadoChart"].forEach(id => el[id] = document.getElementById(id));
  document.getElementById('year').textContent = new Date().getFullYear();
  el.runBtn.addEventListener('click', run);
  drawEmpty();
});

function params(){
  const clamp = (x,min,max)=> Math.max(min,Math.min(max,x));
  const clampPct = v => clamp(Number(v)||0, 0, 100);
  return {
    periods: clamp(parseInt(el.periods.value||"12"), 3, 60),
    sims: clamp(parseInt(el.sims.value||"10000"), 1000, 100000),
    seed: el.seed.value ? Number(el.seed.value) : null,
    demand: { dist: el.demandDist.value, mu: Number(el.demandMu.value), sigma: Number(el.demandSigma.value) },
    aov: Number(el.aov.value),
    cogsPct: clampPct(el.cogsPct.value),
    varCostPct: clampPct(el.varCostPct.value),
    startingCash: Number(el.startingCash.value),
    fixedCost: Number(el.fixedCost.value),
    dsoDays: clamp(Number(el.dsoDays.value), 0, 120),
    latePayPct: clampPct(el.latePayPct.value),
    taxRate: clampPct(el.taxRate.value),
    shortfallThresh: Number(el.shortfallThresh.value),
  };
}

function run(){
  const p = params();
  el.status.textContent = "Running…";
  el.runBtn.disabled = true;
  setTimeout(() => {
    try{
      const res = runSim(p);
      renderAll(res);
      el.status.textContent = `Done. Sims: ${p.sims.toLocaleString()}`;
    }catch(err){
      console.error(err);
      el.status.textContent = "Error: " + (err.message||err);
    }finally{
      el.runBtn.disabled = false;
    }
  }, 20);
}

/* ===== Rendering ===== */
function renderAll(res){
  const pct = v => (v*100).toFixed(1) + '%';
  const money = v => (v>=0? '$':'-$') + Math.abs(v).toLocaleString(undefined,{maximumFractionDigits:0});

  el.kpiShortfall.textContent = pct(res.metrics.pShortfallAny);
  el.kpiEndNeg.textContent    = pct(res.metrics.pEndCashNeg);
  el.kpiVaR.textContent       = money(res.metrics.var5);
  el.kpiMedian.textContent    = money(res.metrics.medianEnd);

  // Fan chart
  const x = res.timeline, b = res.bands;
  const traces = [
    {x, y:b.p95, mode:'lines', line:{width:0}, showlegend:false},
    {x, y:b.p5,  mode:'lines', line:{width:0}, fill:'tonexty', fillcolor:'rgba(106,209,255,.08)'},
    {x, y:b.p75, mode:'lines', line:{width:0}, showlegend:false},
    {x, y:b.p25, mode:'lines', line:{width:0}, fill:'tonexty', fillcolor:'rgba(106,209,255,.18)', name:'25–75%'},
    {x, y:b.p50, mode:'lines', line:{color:'#6ad1ff', width:2}, name:'Median'}
  ];
  Plotly.newPlot('fanChart', traces, {
    title:'Cash Balance — Uncertainty Bands',
    xaxis:{title:'Month', dtick:1, gridcolor:'rgba(255,255,255,.06)'},
    yaxis:{title:'Cash ($)', gridcolor:'rgba(255,255,255,.06)'},
    paper_bgcolor:'transparent', plot_bgcolor:'transparent', showlegend:true, legend:{orientation:'h'}
  }, {displayModeBar:false, responsive:true});

  // Histogram
  const n=40, arr=res.endingCash, min=Math.min(...arr), max=Math.max(...arr);
  const bins = Array.from({length:n+1},(_,i)=> min + i*(max-min)/n);
  const counts = new Array(n).fill(0);
  for(const v of arr){ const i=Math.min(n-1, Math.max(0, Math.floor((v-min)/((max-min)||1)*n))); counts[i]++; }
  const centers = bins.slice(0,-1).map((b,i)=> (b+bins[i+1])/2);
  Plotly.newPlot('histChart', [{x:centers,y:counts,type:'bar',marker:{color:'#6ad1ff'}}], {
    title:'Distribution — Ending Cash',
    xaxis:{title:'End cash ($)', gridcolor:'rgba(255,255,255,.06)'},
    yaxis:{title:'Count', gridcolor:'rgba(255,255,255,.06)'},
    paper_bgcolor:'transparent', plot_bgcolor:'transparent', showlegend:false
  }, {displayModeBar:false, responsive:true});

  // Tornado
  const items = [...res.tornado.items].sort((a,b)=> Math.max(Math.abs(b.deltaLow),Math.abs(b.deltaHigh)) - Math.max(Math.abs(a.deltaLow),Math.abs(a.deltaHigh)));
  const names=items.map(d=>d.name), low=items.map(d=>d.deltaLow*100), high=items.map(d=>d.deltaHigh*100);
  Plotly.newPlot('tornadoChart', [
    {x:low,  y:names, type:'bar', orientation:'h', name:'-10%', marker:{color:'rgba(255,107,107,.85)'}},
    {x:high, y:names, type:'bar', orientation:'h', name:'+10%', marker:{color:'rgba(66,211,146,.85)'}}
  ], {
    title:'Sensitivity: ΔP(Shortfall) when varying one input ±10%',
    xaxis:{title:'Percentage points', zeroline:true, zerolinewidth:2, gridcolor:'rgba(255,255,255,.06)'},
    yaxis:{automargin:true, gridcolor:'rgba(255,255,255,.06)'},
    barmode:'overlay', paper_bgcolor:'transparent', plot_bgcolor:'transparent', showlegend:true, legend:{orientation:'h'}
  }, {displayModeBar:false, responsive:true});
}

function drawEmpty(){
  Plotly.newPlot('fanChart', [], {paper_bgcolor:'transparent', plot_bgcolor:'transparent'}, {displayModeBar:false});
  Plotly.newPlot('histChart', [], {paper_bgcolor:'transparent', plot_bgcolor:'transparent'}, {displayModeBar:false});
  Plotly.newPlot('tornadoChart', [], {paper_bgcolor:'transparent', plot_bgcolor:'transparent'}, {displayModeBar:false});
}

/* ===== Monte Carlo (main thread) ===== */
function runSim(p){
  const rng = seeded(p.seed == null ? Math.floor(Math.random()*1e9) : p.seed);
  const months = clamp(p.periods|0,3,60), sims = clamp(p.sims|0,1000,100000);
  const dsoM = Math.round(p.dsoDays/30), late = clamp01(p.latePayPct/100);
  const cogs = clamp01(p.cogsPct/100), varc = clamp01(p.varCostPct/100), tax = clamp01(p.taxRate/100);
  const thresh = Number(p.shortfallThresh)||0;

  const timeline = Array.from({length:months},(_,i)=>i+1);
  const mat = Array.from({length:months},()=> new Float64Array(sims));
  const endCash = new Float64Array(sims);
  let shortfallAny=0, endNeg=0;

  for(let s=0;s<sims;s++){
    let cash = +p.startingCash||0;
    const rev=new Float64Array(months), cost=new Float64Array(months);
    for(let t=0;t<months;t++){
      const demand = sampleDemand(p.demand.dist, p.demand.mu, p.demand.sigma, rng);
      const revenue = demand * p.aov;
      const cogsCost = revenue*cogs, varCost = revenue*varc, fixed=p.fixedCost;
      const pbt = revenue - (cogsCost + varCost + fixed);
      const taxPay = pbt>0 ? tax*pbt : 0;
      rev[t]=revenue; cost[t]=(cogsCost + varCost + fixed - taxPay);
    }
    for(let t=0;t<months;t++){
      const i0=t-dsoM, iLate=i0-1; let collect=0;
      if(i0>=0)   collect += rev[i0]*(1-late);
      if(iLate>=0)collect += rev[iLate]*late;
      cash = cash + collect - cost[t];
      mat[t][s]=cash;
      if (cash < thresh) { shortfallAny++; break; }
    }
    endCash[s]=cash; if(cash<0) endNeg++;
  }

  const bands = {p5:[],p25:[],p50:[],p75:[],p95:[]};
  for(let t=0;t<months;t++){
    const a = Array.from(mat[t]).sort((x,y)=>x-y);
    bands.p5.push(qSorted(a,0.05)); bands.p25.push(qSorted(a,0.25));
    bands.p50.push(qSorted(a,0.50)); bands.p75.push(qSorted(a,0.75)); bands.p95.push(qSorted(a,0.95));
  }
  const endArr = Array.from(endCash).sort((x,y)=>x-y);
  const var5 = qSorted(endArr,0.05), med = qSorted(endArr,0.50);

  const tornado = sensitivity(p, 3000);

  return {
    timeline, bands, endingCash: Array.from(endCash),
    metrics: { pShortfallAny: shortfallAny/sims, pEndCashNeg: endNeg/sims, var5, medianEnd: med },
    tornado
  };
}

/* Sensitivity (±10% one-at-a-time) */
function sensitivity(base, simsSmall){
  const params = [
    { key:'demand.mu', label:'Demand mean' },
    { key:'demand.sigma', label:'Demand std' },
    { key:'aov', label:'Average order value' },
    { key:'cogsPct', label:'COGS %' },
    { key:'varCostPct', label:'Var Opex %' },
    { key:'fixedCost', label:'Fixed cost' },
    { key:'dsoDays', label:'DSO days' }
  ];
  const baseRisk = riskShortfall(base, simsSmall);
  const items = params.map(n=>{
    const lo = riskShortfall(nudge(base,n.key,-0.10), simsSmall);
    const hi = riskShortfall(nudge(base,n.key,+0.10), simsSmall);
    return { name:n.label, deltaLow:lo-baseRisk, deltaHigh:hi-baseRisk };
  });
  return { base: baseRisk, items };
}
function nudge(obj, dotted, frac){
  const copy = JSON.parse(JSON.stringify(obj));
  const parts = dotted.split('.'); let ref = copy;
  for (let i=0;i<parts.length-1;i++) ref = ref[parts[i]];
  const k = parts.at(-1); let v = ref[k];
  if (typeof v==='number'){ v = v*(1+frac);
    if (k.includes('Pct')) v = clamp(v,0,100);
    if (k==='dsoDays') v = clamp(v,0,120);
    if (k==='sigma' && v<=0) v = 1e-6;
    ref[k]=v;
  }
  return copy;
}
function riskShortfall(p, sims){
  const rng = seeded(987654321);
  const months = clamp(p.periods|0,3,60);
  const dsoM = Math.round(p.dsoDays/30), late = clamp01(p.latePayPct/100);
  const cogs = clamp01(p.cogsPct/100), varc = clamp01(p.varCostPct/100), tax = clamp01(p.taxRate/100);
  const thr = Number(p.shortfallThresh)||0;
  let short=0;
  for(let s=0;s<sims;s++){
    let cash = +p.startingCash||0;
    const rev=new Float64Array(months), cost=new Float64Array(months);
    for(let t=0;t<months;t++){
      const demand = sampleDemand(p.demand.dist, p.demand.mu, p.demand.sigma, rng);
      const revenue = demand * p.aov;
      const cogsCost = revenue*cogs, varCost=revenue*varc, fixed=p.fixedCost;
      const pbt = revenue - (cogsCost + varCost + fixed);
      const taxPay = pbt>0 ? tax*pbt : 0;
      rev[t]=revenue; cost[t]=(cogsCost + varCost + fixed - taxPay);
    }
    for(let t=0;t<months;t++){
      const i0=t-dsoM, iLate=i0-1; let collect=0;
      if (i0>=0) collect += rev[i0]*(1-late);
      if (iLate>=0) collect += rev[iLate]*late;
      cash = cash + collect - cost[t];
      if (cash < thr){ short++; break; }
    }
  }
  return short/sims;
}

/* RNG & dists */
function seeded(seed){ if (seed==null) seed=Math.floor(Math.random()*2**31); return mulberry32(seed); }
function mulberry32(seed){ let t=seed>>>0; return function(){ t|=0; t=t+0x6D2B79F5|0; let r=Math.imul(t^t>>>15,1|t)+Math.imul(t^t>>>7,61|t)^t; return ((r^r>>>14)>>>0)/4294967296; }; }
function randn(rng){ let u=0,v=0; while(u===0) u=rng(); while(v===0) v=rng(); return Math.sqrt(-2*Math.log(u))*Math.cos(2*Math.PI*v); }
function sampleDemand(dist, mu, sigma, rng){
  if (dist==='poisson'){ const L=Math.exp(-Math.max(0,mu)); let k=0,p=1; do{ k++; p*=rng(); } while(p>L); return k-1; }
  if (dist==='lognormal'){ const m=Math.max(1e-9,mu), s=Math.max(1e-9,sigma);
    const phi=Math.sqrt(1+(s*s)/(m*m)); const muL=Math.log(m/phi); const sigmaL=Math.sqrt(Math.log(phi*phi));
    return Math.max(0, Math.exp(muL + sigmaL*randn(rng)));
  }
  return Math.max(0, mu + sigma*randn(rng)); // truncated normal
}

/* Utils */
const clamp = (x,min,max)=> Math.max(min,Math.min(max,x));
const clamp01 = x => Math.max(0,Math.min(1,x));
function qSorted(a,q){ const n=a.length; if(!n) return NaN; const pos=(n-1)*q, b=Math.floor(pos), r=pos-b; return a[b+1]!==undefined? a[b]+r*(a[b+1]-a[b]) : a[b]; }
</script>
</body>
</html>
