<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Monte Carlo Cash-Flow Risk Simulator</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Monte Carlo Cash-Flow Risk Simulator</h1>
      <p>
        Fast, client-side simulator for uncertainty bands, shortfall probability,
        Value at Risk, and sensitivity.
      </p>
    </header>

    <main>
      <!-- Left panel: Inputs -->
      <section class="inputs">
        <h2>Inputs</h2>
        <label>Months <input id="periods" type="number" value="12" /></label>
        <label>Simulations <input id="sims" type="number" value="10000" /></label>
        <label>Seed (optional) <input id="seed" type="number" /></label>

        <h3>Demand & Revenue</h3>
        <label>Demand distribution
          <select id="demandDist">
            <option value="normal">Normal</option>
            <option value="poisson">Poisson</option>
          </select>
        </label>
        <label>Demand mean/λ <input id="demandMu" type="number" value="500" /></label>
        <label>Demand std (ignored for Poisson) <input id="demandSigma" type="number" value="120" /></label>
        <label>Average order value ($) <input id="aov" type="number" value="120" /></label>

        <h3>COGS & Costs</h3>
        <label>COGS (% of revenue) <input id="cogsPct" type="number" value="45" /></label>
        <label>Variable Opex (% of revenue) <input id="varCostPct" type="number" value="40" /></label>
        <label>Fixed monthly cost ($) <input id="fixedCost" type="number" value="18000" /></label>
        <label>Starting cash ($) <input id="startingCash" type="number" value="50000" /></label>

        <h3>Cash Timing & Expenses</h3>
        <label>DSO (days sales outstanding) <input id="dsoDays" type="number" value="30" /></label>
        <label>Late pay share (% shifted +1 mo) <input id="latePayPct" type="number" value="10" /></label>
        <label>Tax rate (% on positive PBT) <input id="taxRate" type="number" value="0" /></label>
        <label>Shortfall threshold ($) <input id="shortfallThresh" type="number" value="1000" /></label>

        <button id="runBtn">Run Simulation</button>
        <p id="status">Idle.</p>
      </section>

      <!-- Right panel: Results -->
      <section class="results">
        <h2>Results</h2>
        <div class="kpis">
          <div>Any shortfall: <span id="kpiShortfall">–</span></div>
          <div>End cash < 0: <span id="kpiEndNeg">–</span></div>
          <div>VaR5% (End Cash): <span id="kpiVaR">–</span></div>
          <div>Median End Cash: <span id="kpiMedian">–</span></div>
        </div>

        <div id="fanChart" class="chart"></div>
        <div id="histChart" class="chart"></div>
        <div id="tornadoChart" class="chart"></div>
      </section>
    </main>

    <!-- Model notes -->
    <section class="notes">
      <h2>Model Notes (transparent by design)</h2>
      <pre>
Revenue_t = Demand_t * AOV
COGS_t = Revenue_t * cogsPct
VarOpex_t = Revenue_t * varCostPct
PBT_t = Revenue_t - COGS_t - VarOpex_t - fixedCost
Tax_t = max(0, PBT_t) * taxRate
Cash_t = Cash_(t-1) + Revenue_t - (COGS_t+VarOpex_t+fixedCost) - Tax_t
      </pre>
    </section>

    <footer>
      <p>&copy; <span id="year"></span> Monte Carlo Simulator Demo</p>
    </footer>
  </div>

  <!-- Dual-script bootstrap -->
  <script>
    (function () {
      const head = document.getElementsByTagName('head')[0];
      function load(src){ var s=document.createElement('script'); s.src = src + '?v=2'; head.appendChild(s); }
      if ('Worker' in window) {
        load('scripts/app.js');
        setTimeout(function(){
          if (!window.__MC_APP_READY__) {
            console.warn('[MC] Worker app didn’t start; loading fallback.');
            load('scripts/app.noworker.js');
          }
        }, 1500);
      } else {
        load('scripts/app.noworker.js');
      }
    })();
  </script>
</body>
</html>
